<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Signaturendruck</title>
        <style type="text/css"> 
            #filecontents, #tableBox, #testBox { 
                border:double; 
                overflow-y:scroll; 
                height:200px; 
            }
            .toPrint {
                width: 50px;
                height: 50px;
                padding: 0px;
                margin: 0px;
            }
        </style>
    </head>
    <body>
        <p>Die Signaturen stammen aus: <span id="defaultPath"></span></p>
        <p>Eine andere Datei ausw√§hlen: 
            <input type="file" id="fileToRead" />
        </p>
        <div id="tableBox">
            <table id="signaturTable">
                <tr>
                    <!-- <th onclick="sortTable(0)">Signatur</th>
                    <th onclick="sortTable(1)">Bearbeitet am</th>
                    <th onclick="sortTable(2)">Exemplar</th> -->
                    <th>Signatur</th>
                    <th>Bearbeitet am</th>
                    <th>Exemplar</th>
                    <th>Kurze Signatur</th>
                    <th>Drucken</th>
                    <th>Anzahl</th>
                </tr>
            </table>
        </div>
        <div hidden>Folgende verwertbare Informationen sind enthalten:</div> 
        <div id="filecontents" hidden>
        </div>
        <div id="buttonBox">
            <button onclick="changeStyle()">changeStyle</button>
            <button onclick="loadData()">loadData</button>
            <button onclick="preview(2)">preview</button>
            <button onclick="printButton()">Drucken</button>
        </div>
        <div id="testBox">
            <div id="previewBox" style="background: #00f8d7">

            </div>
            <div id="toPDF" hidden>
                <div>Test</div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" id="capture" style="background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" style="background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" style="background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" style="background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" style=" background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
                <div class="html2pdf__page-break"></div>
                <div class="toPrint" style="background: #f5da55">
                    <h4 style="color: #000; margin: 0px">Hello world!</h4>
                </div>
            </div>
        </div>
        <script>
        // You can also require other files to run in this process
            require('./renderer.js')
            // required for pdf creation
            const html2canvas = require("html2canvas")
            const jsPDF = require("jspdf");
            const html2pdf = require("html2pdf.js")
            // required for file stuff
            const fs = require("fs");
            // requires lodash
            const _ = require("lodash");
            // required for persistent config
            const Store = require("electron-store");
            const store = new Store();
            // required for ipc calls to the main process
            const ipc = require("electron").ipcRenderer;
        </script>
        <script src="./sortTable.js"></script>
        <script>
            function changeStyle() {
                let newConfig = loadConfig();
                console.log(newConfig);
                let toPrint = document.getElementsByClassName("toPrint");
                let width = newConfig.gross.label.width;;
                let height = newConfig.gross.label.height;;
                let unit = newConfig.einheit;;
                console.log(toPrint);
                width = newConfig.gross.label.width;
                height = newConfig.gross.label.height;
                console.log(width, height);
                for (let i = 0; i < toPrint.length; i++) {
                    toPrint[i].style.width = '' + width + unit;
                    toPrint[i].style.height = '' + height + unit;
                    // toPrint[i].style.margin = '50px';'
                }
            console.log(toPrint);
            }
            function createPDF() {
                // html2canvas(document.querySelector("#capture")).then(canvas => {
                //     document.body.appendChild(canvas);
                // });
                changeStyle();
                let newConfig = loadConfig();
                var element = document.getElementById("toPDF");
                html2pdf(element, {
                    margin:       1,
                    filename:     'myfile.pdf',
                    image:        { type: 'png', quality: 0.99 },
                    html2canvas:  { dpi: 192, letterRendering: true },
                    jsPDF:        { unit: 'px', format: [newConfig.gross.label.width + 3, newConfig.gross.label.height + 3], orientation: 'portrait' }
                });
            }
            function loadConfig() {
                return store.store;
            }
        </script>
        <script>
            function loadData() {
                fs.readFile("signaturen.json", "utf8", function readFileCallback(err, data){
                    if (err){
                        console.log(err);
                    } else {
                        output(JSON.parse(data));
                        console.log("signaturen.json wurde gelesen");
                    }
                });
            }
            function output(obj) {
                var table = document.getElementById("signaturTable");
                var i = 1;
                _.forEach(obj, function(key, value){
                    var row = table.insertRow(i);
                    var ppnRow = row.insertCell(0);
                    ppnRow.innerHTML = value;
                    ppnRow.className = "ppnLine";
                    _.forEach(key, function(objct){
                        i++;
                        row = table.insertRow(i);
                        // row.onclick = function() { preview(objct.id); };
                        var txtCell = row.insertCell(0);
                        txtCell.onclick = function() { preview(objct.id); };
                        var dateCell = row.insertCell(1);
                        dateCell.onclick = function() { preview(objct.id); };
                        var exnrCell = row.insertCell(2);
                        exnrCell.onclick = function() { preview(objct.id); };
                        var shortSigCell = row.insertCell(3);
                        var printSigCell = row.insertCell(4);
                        var printCount = row.insertCell(5);
                        _.forEach(objct.txt, function(value){
                            txtCell.innerHTML += value + " ";
                        });
                        dateCell.innerHTML = objct.date;
                        exnrCell.innerHTML = objct.exNr;
                        let input = document.createElement("input");
                        input.id = "short_" + objct.id;
                        input.type = "checkbox";
                        input.name = "shortShelfmark";
                        input.value = objct.id;
                        shortSigCell.appendChild(input);
                        input = document.createElement("input");
                        input.id = "print_" + objct.id;
                        input.type = "checkbox";
                        input.name = "toPrint";
                        input.value = objct.id;
                        printSigCell.appendChild(input);
                        input = document.createElement("input");
                        input.id = "count_" + objct.id;
                        input.type = "number";
                        input.max = 99;
                        input.min = 1;
                        input.name = "printCount";
                        input.value = 1;
                        printCount.appendChild(input);
                    });
                    i++;
                });
            }
        </script>
        <script>
            function preview(id) {
                fs.readFile("signaturen.json", "utf8", function readFileCallback(err, data){
                    if (err){
                        console.log(err);
                    } else {
                        let sig = "";
                        _.forEach(JSON.parse(data), function(key, value){
                            let found = _.find(key, {"id": id});
                            if (found !== undefined) {
                                sig = found;
                            }
                        });
                        if (sig != "") {
                            console.log(sig);
                            let length = sig.txtLength;
                            let i = 1;
                            let line = document.createElement('p');
                            console.log(length);
                            if (length > 3) {
                                console.log("added stuff");
                            } else {

                            }
                            let myNode = document.getElementById("previewBox");
                            while (myNode.firstChild) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            sig.txt.forEach(element => {
                                line.className = "previewLine";
                                line.id = "line" + i;
                                if (element == "") {
                                    let emptyLine = document.createElement("br");
                                line.appendChild(emptyLine);
                                } else {
                                    line.innerHTML = element;
                                }
                                document.getElementById("previewBox").appendChild(line);
                                line = document.createElement('p');
                                i++;
                            });
                        }
                    }
                });
            }
        </script>
        <script>
            function printButton() {
                var elems= document.querySelectorAll('[name=toPrint]')
                let toPrint = [];
                for (var i=0;i<elems.length;i++)
                {
                    let isChecked = elems[i].checked;
                    if (elems[i].checked) {
                        toPrint.push(elems[i].value);
                    }
                }
                console.log("checked ",toPrint);
                ipc.send("print", toPrint);
            }
        </script>
    </body>
</html>
